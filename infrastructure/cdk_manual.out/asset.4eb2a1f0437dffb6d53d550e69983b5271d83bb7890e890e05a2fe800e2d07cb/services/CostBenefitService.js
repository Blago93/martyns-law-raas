"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CostBenefitService = void 0;
const client_bedrock_runtime_1 = require("@aws-sdk/client-bedrock-runtime");
const pdfkit_1 = require("pdfkit");
const fs_1 = require("fs");
const path_1 = require("path");
// Constants mirroring SMT policy
const VPF = 2400000.0;
const GDF = 10.0;
class CostBenefitService {
    constructor() {
        this.bedrockClient = new client_bedrock_runtime_1.BedrockRuntimeClient({ region: process.env.AWS_REGION || 'eu-west-2' });
    }
    /**
     * Estimates cost and risk if not provided, then evaluates standard.
     */
    async evaluateMeasure(report) {
        let cost = report.estimatedCost;
        let riskDelta = report.estimatedRiskReduction;
        if (cost === undefined || riskDelta === undefined) {
            const estimates = await this.estimateParameters(report.description);
            cost = estimates.cost;
            riskDelta = estimates.riskDelta;
        }
        const benefit = riskDelta * VPF;
        const threshold = benefit * GDF;
        // Logic: Mandatory if Cost <= Benefit * GDF
        const isMandatory = cost <= threshold;
        const status = isMandatory ? 'MANDATORY' : 'DISPROPORTIONATE';
        let certificatePath;
        if (status === 'DISPROPORTIONATE') {
            certificatePath = await this.generateCertificate(report, cost, threshold);
        }
        return {
            isMandatory,
            status,
            details: {
                cost: cost,
                benefit,
                threshold
            },
            certificatePath
        };
    }
    async estimateParameters(description) {
        // Mock implementation for prototype if Bedrock fails or env vars missing
        // In prod: Use Bedrock with specific prompt to extract/estimate values
        console.log(`Estimating for: ${description}`);
        // Placeholder AI logic
        // "Lack of blast glazing" typically high cost, moderate risk reduction
        if (description.toLowerCase().includes('blast glazing')) {
            return { cost: 15000, riskDelta: 0.0005 }; // Cost 15k, Risk reduced by 0.05% of a fatality
        }
        return { cost: 5000, riskDelta: 0.0001 };
    }
    async generateCertificate(report, cost, threshold) {
        return new Promise((resolve, reject) => {
            const doc = new pdfkit_1.default();
            const filename = `cert_${Date.now()}_${report.vulnerabilityId}.pdf`;
            const outputDir = path_1.default.join(__dirname, '../../uploads/certificates'); // storage path
            if (!fs_1.default.existsSync(outputDir)) {
                fs_1.default.mkdirSync(outputDir, { recursive: true });
            }
            const loadPath = path_1.default.join(outputDir, filename);
            const stream = fs_1.default.createWriteStream(loadPath);
            doc.pipe(stream);
            doc.fontSize(20).text('CERTIFICATE OF DISPROPORTIONALITY', { align: 'center' });
            doc.moveDown();
            doc.fontSize(12).text(`Vulnerability: ${report.description}`);
            doc.text(`Date: ${new Date().toISOString()}`);
            doc.moveDown();
            doc.text(`Estimated Cost: £${cost.toFixed(2)}`);
            doc.text(`Max "Reasonably Practicable" Cost (Threshold): £${threshold.toFixed(2)}`);
            doc.moveDown();
            doc.fontSize(14).fillColor('red').text('VERDICT: REJECTED');
            doc.fontSize(12).fillColor('black').text('This measure was rejected under Section 27 as Grossly Disproportionate (Factor > 10).');
            doc.moveDown();
            doc.text('Calculated using The Martyn\'s Law Reasonably Practicable Engine (SMT-Verified).');
            doc.end();
            stream.on('finish', () => resolve(loadPath));
            stream.on('error', reject);
        });
    }
}
exports.CostBenefitService = CostBenefitService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29zdEJlbmVmaXRTZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQ29zdEJlbmVmaXRTZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDRFQUEyRjtBQUMzRixtQ0FBaUM7QUFDakMsMkJBQW9CO0FBQ3BCLCtCQUF3QjtBQUV4QixpQ0FBaUM7QUFDakMsTUFBTSxHQUFHLEdBQUcsU0FBUyxDQUFDO0FBQ3RCLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQztBQXFCakIsTUFBYSxrQkFBa0I7SUFHM0I7UUFDSSxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksNkNBQW9CLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksV0FBVyxFQUFFLENBQUMsQ0FBQztJQUNyRyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsZUFBZSxDQUFDLE1BQTJCO1FBQzdDLElBQUksSUFBSSxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUM7UUFDaEMsSUFBSSxTQUFTLEdBQUcsTUFBTSxDQUFDLHNCQUFzQixDQUFDO1FBRTlDLElBQUksSUFBSSxLQUFLLFNBQVMsSUFBSSxTQUFTLEtBQUssU0FBUyxFQUFFLENBQUM7WUFDaEQsTUFBTSxTQUFTLEdBQUcsTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3BFLElBQUksR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDO1lBQ3RCLFNBQVMsR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDO1FBQ3BDLENBQUM7UUFFRCxNQUFNLE9BQU8sR0FBRyxTQUFVLEdBQUcsR0FBRyxDQUFDO1FBQ2pDLE1BQU0sU0FBUyxHQUFHLE9BQU8sR0FBRyxHQUFHLENBQUM7UUFFaEMsNENBQTRDO1FBQzVDLE1BQU0sV0FBVyxHQUFHLElBQUssSUFBSSxTQUFTLENBQUM7UUFDdkMsTUFBTSxNQUFNLEdBQUcsV0FBVyxDQUFDLENBQUMs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QyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1lBQzVELEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyx1RkFBdUYsQ0FBQyxDQUFDO1lBQ2xJLEdBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNmLEdBQUcsQ0FBQyxJQUFJLENBQUMsa0ZBQWtGLENBQUMsQ0FBQztZQUU3RixHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7WUFFVixNQUFNLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUM3QyxNQUFNLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQztRQUMvQixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7Q0FDSjtBQTdGRCxnREE2RkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCZWRyb2NrUnVudGltZUNsaWVudCwgSW52b2tlTW9kZWxDb21tYW5kIH0gZnJvbSBcIkBhd3Mtc2RrL2NsaWVudC1iZWRyb2NrLXJ1bnRpbWVcIjtcclxuaW1wb3J0IFBERkRvY3VtZW50IGZyb20gJ3BkZmtpdCc7XHJcbmltcG9ydCBmcyBmcm9tICdmcyc7XHJcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xyXG5cclxuLy8gQ29uc3RhbnRzIG1pcnJvcmluZyBTTVQgcG9saWN5XHJcbmNvbnN0IFZQRiA9IDI0MDAwMDAuMDtcclxuY29uc3QgR0RGID0gMTAuMDtcclxuXHJcbmludGVyZmFjZSBWdWxuZXJhYmlsaXR5UmVwb3J0IHtcclxuICAgIHZ1bG5lcmFiaWxpdHlJZDogc3RyaW5nO1xyXG4gICAgZGVzY3JpcHRpb246IHN0cmluZztcclxuICAgIC8vIE9wdGlvbmFsOiBpZiBhbHJlYWR5IGtub3duXHJcbiAgICBlc3RpbWF0ZWRDb3N0PzogbnVtYmVyO1xyXG4gICAgZXN0aW1hdGVkUmlza1JlZHVjdGlvbj86IG51bWJlcjtcclxufVxyXG5cclxuaW50ZXJmYWNlIEFzc2Vzc21lbnRSZXN1bHQge1xyXG4gICAgaXNNYW5kYXRvcnk6IGJvb2xlYW47XHJcbiAgICBzdGF0dXM6ICdNQU5EQVRPUlknIHwgJ0RJU1BST1BPUlRJT05BVEUnO1xyXG4gICAgZGV0YWlsczoge1xyXG4gICAgICAgIGNvc3Q6IG51bWJlcjtcclxuICAgICAgICBiZW5lZml0OiBudW1iZXI7XHJcbiAgICAgICAgdGhyZXNob2xkOiBudW1iZXI7XHJcbiAgICB9O1xyXG4gICAgY2VydGlmaWNhdGVQYXRoPzogc3RyaW5nO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgQ29zdEJlbmVmaXRTZXJ2aWNlIHtcclxuICAgIHByaXZhdGUgYmVkcm9ja0NsaWVudDogQmVkcm9ja1J1bnRpbWVDbGllbnQ7XHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgdGhpcy5iZWRyb2NrQ2xpZW50ID0gbmV3IEJlZHJvY2tSdW50aW1lQ2xpZW50KHsgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIHx8ICdldS13ZXN0LTInIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogRXN0aW1hdGVzIGNvc3QgYW5kIHJpc2sgaWYgbm90IHByb3ZpZGVkLCB0aGVuIGV2YWx1YXRlcyBzdGFuZGFyZC5cclxuICAgICAqL1xyXG4gICAgYXN5bmMgZXZhbHVhdGVNZWFzdXJlKHJlcG9ydDogVnVsbmVyYWJpbGl0eVJlcG9ydCk6IFByb21pc2U8QXNzZXNzbWVudFJlc3VsdD4ge1xyXG4gICAgICAgIGxldCBjb3N0ID0gcmVwb3J0LmVzdGltYXRlZENvc3Q7XHJcbiAgICAgICAgbGV0IHJpc2tEZWx0YSA9IHJlcG9ydC5lc3RpbWF0ZWRSaXNrUmVkdWN0aW9uO1xyXG5cclxuICAgICAgICBpZiAoY29zdCA9PT0gdW5kZWZpbmVkIHx8IHJpc2tEZWx0YSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGVzdGltYXRlcyA9IGF3YWl0IHRoaXMuZXN0aW1hdGVQYXJhbWV0ZXJzKHJlcG9ydC5kZXNjcmlwdGlvbik7XHJcbiAgICAgICAgICAgIGNvc3QgPSBlc3RpbWF0ZXMuY29zdDtcclxuICAgICAgICAgICAgcmlza0RlbHRhID0gZXN0aW1hdGVzLnJpc2tEZWx0YTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGJlbmVmaXQgPSByaXNrRGVsdGEhICogVlBGO1xyXG4gICAgICAgIGNvbnN0IHRocmVzaG9sZCA9IGJlbmVmaXQgKiBHREY7XHJcblxyXG4gICAgICAgIC8vIExvZ2ljOiBNYW5kYXRvcnkgaWYgQ29zdCA8PSBCZW5lZml0ICogR0RGXHJcbiAgICAgICAgY29uc3QgaXNNYW5kYXRvcnkgPSBjb3N0ISA8PSB0aHJlc2hvbGQ7XHJcbiAgICAgICAgY29uc3Qgc3RhdHVzID0gaXNNYW5kYXRvcnkgPyAnTUFOREFUT1JZJyA6ICdESVNQUk9QT1JUSU9OQVRFJztcclxuXHJcbiAgICAgICAgbGV0IGNlcnRpZmljYXRlUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkO1xyXG5cclxuICAgICAgICBpZiAoc3RhdHVzID09PSAnRElTUFJPUE9SVElPTkFURScpIHtcclxuICAgICAgICAgICAgY2VydGlmaWNhdGVQYXRoID0gYXdhaXQgdGhpcy5nZW5lcmF0ZUNlcnRpZmljYXRlKHJlcG9ydCwgY29zdCEsIHRocmVzaG9sZCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBpc01hbmRhdG9yeSxcclxuICAgICAgICAgICAgc3RhdHVzLFxyXG4gICAgICAgICAgICBkZXRhaWxzOiB7XHJcbiAgICAgICAgICAgICAgICBjb3N0OiBjb3N0ISxcclxuICAgICAgICAgICAgICAgIGJlbmVmaXQsXHJcbiAgICAgICAgICAgICAgICB0aHJlc2hvbGRcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgY2VydGlmaWNhdGVQYXRoXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFzeW5jIGVzdGltYXRlUGFyYW1ldGVycyhkZXNjcmlwdGlvbjogc3RyaW5nKTogUHJvbWlzZTx7IGNvc3Q6IG51bWJlciwgcmlza0RlbHRhOiBudW1iZXIgfT4ge1xyXG4gICAgICAgIC8vIE1vY2sgaW1wbGVtZW50YXRpb24gZm9yIHByb3RvdHlwZSBpZiBCZWRyb2NrIGZhaWxzIG9yIGVudiB2YXJzIG1pc3NpbmdcclxuICAgICAgICAvLyBJbiBwcm9kOiBVc2UgQmVkcm9jayB3aXRoIHNwZWNpZmljIHByb21wdCB0byBleHRyYWN0L2VzdGltYXRlIHZhbHVlc1xyXG4gICAgICAgIGNvbnNvbGUubG9nKGBFc3RpbWF0aW5nIGZvcjogJHtkZXNjcmlwdGlvbn1gKTtcclxuXHJcbiAgICAgICAgLy8gUGxhY2Vob2xkZXIgQUkgbG9naWNcclxuICAgICAgICAvLyBcIkxhY2sgb2YgYmxhc3QgZ2xhemluZ1wiIHR5cGljYWxseSBoaWdoIGNvc3QsIG1vZGVyYXRlIHJpc2sgcmVkdWN0aW9uXHJcbiAgICAgICAgaWYgKGRlc2NyaXB0aW9uLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ2JsYXN0IGdsYXppbmcnKSkge1xyXG4gICAgICAgICAgICByZXR1cm4geyBjb3N0OiAxNTAwMCwgcmlza0RlbHRhOiAwLjAwMDUgfTsgLy8gQ29zdCAxNWssIFJpc2sgcmVkdWNlZCBieSAwLjA1JSBvZiBhIGZhdGFsaXR5XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4geyBjb3N0OiA1MDAwLCByaXNrRGVsdGE6IDAuMDAwMSB9O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYXN5bmMgZ2VuZXJhdGVDZXJ0aWZpY2F0ZShyZXBvcnQ6IFZ1bG5lcmFiaWxpdHlSZXBvcnQsIGNvc3Q6IG51bWJlciwgdGhyZXNob2xkOiBudW1iZXIpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRvYyA9IG5ldyBQREZEb2N1bWVudCgpO1xyXG4gICAgICAgICAgICBjb25zdCBmaWxlbmFtZSA9IGBjZXJ0XyR7RGF0ZS5ub3coKX1fJHtyZXBvcnQudnVsbmVyYWJpbGl0eUlkfS5wZGZgO1xyXG4gICAgICAgICAgICBjb25zdCBvdXRwdXREaXIgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vdXBsb2Fkcy9jZXJ0aWZpY2F0ZXMnKTsgLy8gc3RvcmFnZSBwYXRoXHJcblxyXG4gICAgICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMob3V0cHV0RGlyKSkge1xyXG4gICAgICAgICAgICAgICAgZnMubWtkaXJTeW5jKG91dHB1dERpciwgeyByZWN1cnNpdmU6IHRydWUgfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGxvYWRQYXRoID0gcGF0aC5qb2luKG91dHB1dERpciwgZmlsZW5hbWUpO1xyXG4gICAgICAgICAgICBjb25zdCBzdHJlYW0gPSBmcy5jcmVhdGVXcml0ZVN0cmVhbShsb2FkUGF0aCk7XHJcblxyXG4gICAgICAgICAgICBkb2MucGlwZShzdHJlYW0pO1xyXG5cclxuICAgICAgICAgICAgZG9jLmZvbnRTaXplKDIwKS50ZXh0KCdDRVJUSUZJQ0FURSBPRiBESVNQUk9QT1JUSU9OQUxJVFknLCB7IGFsaWduOiAnY2VudGVyJyB9KTtcclxuICAgICAgICAgICAgZG9jLm1vdmVEb3duKCk7XHJcbiAgICAgICAgICAgIGRvYy5mb250U2l6ZSgxMikudGV4dChgVnVsbmVyYWJpbGl0eTogJHtyZXBvcnQuZGVzY3JpcHRpb259YCk7XHJcbiAgICAgICAgICAgIGRvYy50ZXh0KGBEYXRlOiAke25ldyBEYXRlKCkudG9JU09TdHJpbmcoKX1gKTtcclxuICAgICAgICAgICAgZG9jLm1vdmVEb3duKCk7XHJcbiAgICAgICAgICAgIGRvYy50ZXh0KGBFc3RpbWF0ZWQgQ29zdDogwqMke2Nvc3QudG9GaXhlZCgyKX1gKTtcclxuICAgICAgICAgICAgZG9jLnRleHQoYE1heCBcIlJlYXNvbmFibHkgUHJhY3RpY2FibGVcIiBDb3N0IChUaHJlc2hvbGQpOiDCoyR7dGhyZXNob2xkLnRvRml4ZWQoMil9YCk7XHJcbiAgICAgICAgICAgIGRvYy5tb3ZlRG93bigpO1xyXG4gICAgICAgICAgICBkb2MuZm9udFNpemUoMTQpLmZpbGxDb2xvcigncmVkJykudGV4dCgnVkVSRElDVDogUkVKRUNURUQnKTtcclxuICAgICAgICAgICAgZG9jLmZvbnRTaXplKDEyKS5maWxsQ29sb3IoJ2JsYWNrJykudGV4dCgnVGhpcyBtZWFzdXJlIHdhcyByZWplY3RlZCB1bmRlciBTZWN0aW9uIDI3IGFzIEdyb3NzbHkgRGlzcHJvcG9ydGlvbmF0ZSAoRmFjdG9yID4gMTApLicpO1xyXG4gICAgICAgICAgICBkb2MubW92ZURvd24oKTtcclxuICAgICAgICAgICAgZG9jLnRleHQoJ0NhbGN1bGF0ZWQgdXNpbmcgVGhlIE1hcnR5blxcJ3MgTGF3IFJlYXNvbmFibHkgUHJhY3RpY2FibGUgRW5naW5lIChTTVQtVmVyaWZpZWQpLicpO1xyXG5cclxuICAgICAgICAgICAgZG9jLmVuZCgpO1xyXG5cclxuICAgICAgICAgICAgc3RyZWFtLm9uKCdmaW5pc2gnLCAoKSA9PiByZXNvbHZlKGxvYWRQYXRoKSk7XHJcbiAgICAgICAgICAgIHN0cmVhbS5vbignZXJyb3InLCByZWplY3QpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==